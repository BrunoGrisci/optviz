<!doctype html>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/ >
<title>Linking to Data Table</title>

<!-- SlickGrid -->
<link rel="stylesheet" href="lib/slickgrid/slick.grid.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/jquery-ui-1.8.16.custom.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/examples.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/slick.pager.css" type="text/css"/>
<script src="lib/slickgrid/jquery-1.7.min.js"></script>
<script src="lib/slickgrid/jquery.event.drag-2.0.min.js"></script>
<script src="lib/slickgrid/slick.core.js"></script>
<script src="lib/slickgrid/slick.grid.js"></script>
<script src="lib/slickgrid/slick.pager.js"></script>
<script src="lib/slickgrid/slick.dataview.js"></script>
<!-- End SlickGrid -->


<link rel="stylesheet" type="text/css" href="../d3.parcoords.css">
<link rel="stylesheet" type="text/css" href="style.css">
<style>
<style>
body, html {
  margin: 0;
  height: 100%;
  width: 50%;
  overflow: hidden;
  font-size: 12px;
}
#grid, #pager {
  position: fixed;
  width: 100%;
}
#grid {
  bottom: 0;
  height: 600px;
}
#pager {
  bottom: 306px;
  height: 20px;
}
.slick-row:hover {
  font-weight: bold;
  background: 	#DCDCDC;
  color: #069;
}

.legend {
	font-family: 'Raleway', sans-serif;
	fill: #333333;
}

.tooltip {
	fill: #333333;
}

</style>
<script src="lib/d3.min.js"></script>
<script src="../d3.parcoords.js"></script>
<script src="lib/divgrid.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/underscore.math.js"></script>

<!-- Radar Chart -->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
<script src="../radar-chart/radarChart.js"></script>

<!-- End Radar Chart -->

<p>The current time step is <strong id="step">30000.0</strong><br/>
<input type="range" min="30000" max="50000" value="30000.0" step="100.0" id="timestep" style="width:250px;"/>

<div id="example" class="parcoords" style="height:250px;"></div>
<div id="grid" style="width:560px;"></div>
<div id="radar" class="radarChart" align="right"></div>

<script id="brushing">// quantitative color scale

var zcolorscale = d3.scale.linear()
  .domain([-2,-0.5,0.5,2])
  .range(["brown", "#999", "#999", "steelblue"])
  .interpolate(d3.interpolateLab);

var pc = d3.parcoords()("#example")
  //.color(color)
  .alpha(0.4);

var rccolor = d3.scale.ordinal()
    .range(["#CC333F", "#EDC951","#00A0B0", "#006400", "#FF00FF"]);

var rcmargin = {top: 100, right: 100, bottom: 100, left: 100},
	width = Math.min(700, window.innerWidth - 10) - rcmargin.left - rcmargin.right,
	height = Math.min(width, window.innerHeight - rcmargin.top - rcmargin.bottom - 20);

var radarChartOptions = {
  w: 450,
  h: 450,
  margin: rcmargin,
  maxValue: 1,
  levels: 5,
  roundStrokes: false,
  color: rccolor
};

var selecteds = [];
var selectedtemp = null;
var selected = false;
var sel_dim = ' DSSP';
var file_name = 'data/STEPS/30000.csv';

// update color
function changeColor(dimension) {
  sel_dim = dimension;
  pc.svg.selectAll(".dimension")
    .style("font-weight", "normal")
    .filter(function(d) {return d == dimension; })
    .style("font-weight", "bold");

  pc.color(zcolor(pc.data(),dimension)).render();
  
  pc.clear("highlight");                                  
  for (s in selecteds) {
    pc.highlight([selecteds[s]]);
  }
  d3.selectAll([pc.canvas.foreground, pc.canvas.brushed]).classed("faded", false);  
  
}

// return color function based on plot and dimension
function zcolor(col, dimension) {
  var z = zscore(_(col).pluck(dimension).map(parseFloat))
  return function(d) { return zcolorscale(z(d[dimension])) }
};

// color by zscore
function zscore(col) {
  var n = col.length,
      mean = _(col).mean(),
      sigma = _(col).stdDeviation();
  return function(d) {
    return (d-mean)/sigma;
  };
};


function radarChartScale(value, minValue, maxValue) {
    var rcs = d3.scale.linear()
        .domain([minValue, maxValue])
        .range([0, 1]);  
    return rcs(value);   
}

function updateRadarChart(data) {
    var rcdata = [];
    data.forEach(function(d) {
        var s = selecteds.indexOf(d.id);
        if (s > -1) {
            rcdata.push([
                {axis: "DSSP", value: radarChartScale(d[" DSSP"], 0, 18)},
                {axis: "SASA", value: radarChartScale(d[" SASA"], 21, 36)},
                {axis: "GYRATE", value: radarChartScale(d[" GYRATE"], 0.7, 1.2)},                
                {axis: "ENERGY", value: radarChartScale(d[" ENERGY"], -83000, -76000)},
                {axis: "RMSF", value: radarChartScale(d[" RMSF"], 0.2, 0.4)}
            ]);               
        }                                            
    }); 
    if (selectedtemp != null && selecteds.indexOf(selectedtemp.id) < 0) {
        rcdata.push([
                {axis: "DSSP", value: radarChartScale(selectedtemp[" DSSP"], 0, 18)},
                {axis: "SASA", value: radarChartScale(selectedtemp[" SASA"], 21, 36)},
                {axis: "GYRATE", value: radarChartScale(selectedtemp[" GYRATE"], 0.7, 1.2)},                
                {axis: "ENERGY", value: radarChartScale(selectedtemp[" ENERGY"], -83000, -76000)},
                {axis: "RMSF", value: radarChartScale(selectedtemp[" RMSF"], 0.2, 0.4)}        
        ]);   
    }
    else {
        if (selecteds.indexOf(selectedtemp.id) > -1) {
            
        }
    } 
    //Call function to draw the Radar chart
    if (rcdata.length <= 0) {
        rcdata.push([{axis:"", value:0.0}]);    
    }
    RadarChart(".radarChart", rcdata, radarChartOptions);
}

function updateHighlights(data) {
      pc.clear("highlight");
      data.forEach(function(d) {
        var s = selecteds.indexOf(d.id);
        if (s > -1) {
            pc.highlight([d]);
        }                                     
      }); 
      d3.selectAll([pc.canvas.foreground, pc.canvas.brushed]).classed("faded", false); 
}

function parallelCoordinates(file_name) {
    // load csv file and create the chart
    d3.csv(file_name, function(data) {      

      data.forEach(function(d,i) { d.id = d.id || i;});

      pc
        .dimensions({})   
        .data([]) 
        .data(data)
        .hideAxis(["id"])   
        .render() 
        .reorderable()
        .brushMode("1D-axes");  // enable brushing
      
      pc.dimensions()[' DSSP'].yscale.domain([0,18]);
      pc.dimensions()[' SASA'].yscale.domain([21,36]);
      pc.dimensions()[' GYRATE'].yscale.domain([0.7,1.2]);
      pc.dimensions()[' ENERGY'].yscale.domain([-83000,-76000]);
      pc.dimensions()[' RMSF'].yscale.domain([0.2,0.4]);   
      pc.updateAxes();     
             
      changeColor(sel_dim);

     updateHighlights(data); 

     pc.svg.selectAll(".dimension")
        .on("click", function(d) {
            changeColor(d);
            updateHighlights(data);
            })
        .selectAll(".label");

      // update grid on brush
      pc.on("brush", function(d) {
        gridUpdate(d);
      });

    d3.select("#timestep").on("change", function() {
	    d3.select("#step").text(this.value);
        parallelCoordinates('data/STEPS/' + this.value.toString() + '.csv');
    });

////////////////////////////////////////////////////////////////////////////////
	
    updateRadarChart(data);

////////////////////////////////////////////////////////////////////////////////

  // setting up grid
  var column_keys = d3.keys(data[0]);
  var columns = column_keys.map(function(key,i) {
    return {
      id: key,
      name: key,
      field: key,
      sortable: true
    }
  });

  var options = {
    enableCellNavigation: true,
    enableColumnReorder: false,
    multiColumnSort: true
  };

  var dataView = new Slick.Data.DataView();
  var grid = new Slick.Grid("#grid", dataView, columns, options);
  var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));

  // wire up model events to drive the grid
  dataView.onRowCountChanged.subscribe(function (e, args) {
    grid.updateRowCount();
    grid.render();
  });

  dataView.onRowsChanged.subscribe(function (e, args) {
    grid.invalidateRows(args.rows);
    grid.render();
  });

  // column sorting
  var sortcol = column_keys[0];
  var sortdir = 1;

  function comparer(a, b) {
    var x = a[sortcol], y = b[sortcol];
    return (x == y ? 0 : (x > y ? 1 : -1));
  }
  
  // click header to sort grid column
  grid.onSort.subscribe(function (e, args) {
    sortdir = args.sortAsc ? 1 : -1;
    console.log(args.sortCols[0].sortCol.field);
    sortcol = args.sortCols[0].sortCol.field;

    if ($.browser.msie && $.browser.version <= 8) {
      dataView.fastSort(sortcol, args.sortAsc);
    } else {
      dataView.sort(comparer, args.sortAsc);
    }
  });

  grid.onClick.subscribe(function(e,args) {
     // Get row number from grid
     var grid_row = grid.getCellFromEvent(e).row;  
     grid.getColumns().forEach(function(col){//get all the columns
        grid.flashCell(grid_row, grid.getColumnIndex(col.id));//flash it
     });
     grid.setCellCssStyles("highlight", grid_row);
    
    var item_id = grid.getDataItem(grid_row).id; 
    var i = selecteds.indexOf(item_id); 
    if (i > -1) {
        selecteds.splice(i, 1);
    }
    else {
        selecteds.push(item_id);      
    }  

  });

  // highlight row in chart
  grid.onMouseEnter.subscribe(function(e,args) {
    // Get row number from grid
    var grid_row = grid.getCellFromEvent(e).row;  
    // Get the id of the item referenced in grid_row
    var item_id = grid.getDataItem(grid_row).id;
    var d = pc.brushed() || data;
    // Get the element position of the id in the data object
    elementPos = d.map(function(x) {return x.id; }).indexOf(item_id);
    // Highlight that element in the parallel coordinates graph
    pc.highlight([d[elementPos]]);
    
    selectedtemp = grid.getDataItem(grid_row);
    updateRadarChart(data);
    
  });

  grid.onMouseLeave.subscribe(function(e,args) {
    updateHighlights(data);    
    selectedtemp = null;
    updateRadarChart(data);  
  });    

  // fill grid with data
  gridUpdate(data);

  function gridUpdate(data) {
    dataView.beginUpdate();
    dataView.setItems(data);
    dataView.endUpdate();
  };
      
  });
}

parallelCoordinates(file_name);
</script>
